<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ·è³Šç‹ï¼šæ–°ä¸–ç•Œå¤©æ°£</title>
    <meta name="description" content="æ–°ä¸–ç•Œå†’éšªå®¶çš„å¤©æ°£æŒ‡å—ï¼å¨œç¾çš„ç²¾æº–é å ±åŠ©æ‚¨é¿é–‹æƒ¡åŠ£å¤©æ°£ï¼Œèˆªå‘å‰å¤§èˆªé“çš„ç›¡é ­ã€‚">
    <link rel="icon" type="image/png" href="./icon-onepiece.png">
    <link rel="apple-touch-icon" href="./icon-onepiece.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap"
        rel="stylesheet">
    <style>
        /* æµ·è³Šç‹é¢¨æ ¼é¡è‰²å®šç¾© */
        :root {
            --op-bg-red-dark: #A52A2A;   
            --op-bg-red-light: #FF4500;  
            --op-sky-blue: #87CEEB;      
            --op-cloud-white: #F8F8F8;   
            --op-yellow-gold: #FFD700;   
            --op-text-dark: #2A2A2A;     
            --op-text-light: #FFFFFF;    
            --op-card-border: #4B0082;   
            --op-card-bg: rgba(255, 255, 255, 0.95); 
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background: linear-gradient(135deg, var(--op-bg-red-light) 0%, var(--op-bg-red-dark) 30%, var(--op-sky-blue) 70%, #6A86B8 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--op-text-dark);
            overflow-x: hidden;
            padding-bottom: 30px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.3) 0%, transparent 40%),
                              radial-gradient(circle at 80% 90%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
                              url("onepiece.png");
            background-size: cover;
            pointer-events: none;
            z-index: -1;
        }

        /* é ‚éƒ¨å°è¦½åˆ—å®¹å™¨ */
        .city-nav-wrapper {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            border-bottom: 5px solid var(--op-yellow-gold);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        /* å°è¦½åˆ— */
        .city-nav {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 15px 20px 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .city-nav::-webkit-scrollbar {
            display: none;
        }
        
        /* æ‰‹æ©Ÿç‰ˆå°è¦½åˆ—åˆ‡æ›æŒ‰éˆ• */
        .menu-toggle {
            display: none; 
            width: 100%;
            padding: 12px 20px;
            text-align: left;
            font-size: 1.1rem;
            font-weight: 900;
            color: var(--op-text-light);
            background: var(--op-bg-red-dark);
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5);
        }

        .city-button {
            flex-shrink: 0;
            padding: 8px 18px;
            border-radius: 8px;
            font-weight: 900;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease-out;
            border: 3px solid var(--op-yellow-gold);
            color: var(--op-text-dark);
            background: var(--op-cloud-white);
            box-shadow: 5px 5px 0 rgba(0, 0, 0, 0.6);
            text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.5);
        }

        .city-button.selected {
            background: var(--op-bg-red-light);
            color: var(--op-text-light);
            border: 3px solid var(--op-yellow-gold);
            box-shadow: 2px 2px 0 var(--op-text-dark);
            transform: translate(3px, 3px);
            text-shadow: 1px 1px 0 var(--op-text-dark);
        }

        .city-button:active {
            box-shadow: 0 0 0 var(--op-text-dark);
            transform: translate(5px, 5px);
        }

        /* å³ä¸Šè§’æ—¥æœŸæ™‚é–“/ç‹€æ…‹åˆ— */
        .status-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center; 
            gap: 10px;
            padding: 15px 20px 0;
            position: sticky;
            top: 75px; /* æ¡Œé¢ç‰ˆé ‚éƒ¨ä½ç½® */
            z-index: 99;
        }
        
        /* å®šä½ç‹€æ…‹è† å›Šæ¨£å¼ */
        .location-icon-pill {
            font-size: 0.95rem;
            color: var(--op-text-dark);
            background: var(--op-yellow-gold);
            padding: 7px 16px;
            border-radius: 8px;
            font-weight: 700;
            border: 3px solid var(--op-text-dark);
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3);
            display: none; 
            white-space: nowrap; 
        }

        /* æ‰‹å‹•é¸å–ç‹€æ…‹æ¨£å¼ (ä½¿ç”¨ç¾…ç›¤åœ–ç¤º) */
        .location-icon-pill.manual-select {
            background: var(--op-cloud-white); 
        }


        .update-pill {
            font-size: 0.95rem;
            color: var(--op-text-dark);
            background: var(--op-yellow-gold);
            padding: 7px 16px;
            border-radius: 8px;
            font-weight: 700;
            border: 3px solid var(--op-text-dark);
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3);
            display: block; 
        }

        .container {
            padding: 20px;
            max-width: 650px;
            margin: 0 auto;
        }

        /* === æ ¸å¿ƒå¡ç‰‡æ¨£å¼ (ç•¥) === */
        .hero-card {
            background: var(--op-card-bg);
            border-radius: 12px;
            padding: 45px 35px;
            text-align: center;
            border: 6px solid var(--op-card-border);
            box-shadow: 12px 12px 0 rgba(0, 0, 0, 0.7);
            margin-bottom: 35px;
            position: relative;
            transform: rotate(-2deg); 
            overflow: hidden;
            background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0' /%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E");
            background-repeat: repeat;
        }

        .hero-period {
            background: linear-gradient(90deg, var(--op-bg-red-light), var(--op-bg-red-dark));
            color: var(--op-text-light);
            padding: 10px 30px;
            border-radius: 8px;
            font-weight: 900;
            font-size: 1.3rem;
            display: inline-block;
            margin-bottom: 30px;
            border: 4px solid var(--op-yellow-gold);
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.4);
            text-transform: uppercase;
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3);
        }

        .hero-temp-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            margin: 25px 0;
        }

        .hero-icon {
            font-size: 7.5rem;
            filter: drop-shadow(6px 6px 0 rgba(0, 0, 0, 0.3));
            animation: bounce-rotate 5s ease-in-out infinite;
        }
        @keyframes bounce-rotate {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(-2deg); }
        }

        .hero-temp {
            font-size: 6.5rem;
            font-weight: 900;
            color: var(--op-bg-red-light);
            line-height: 1;
            text-shadow: 4px 4px 0 var(--op-text-dark);
        }

        .hero-desc {
            font-size: 1.9rem;
            color: var(--op-text-dark);
            margin-bottom: 30px;
            font-weight: 900;
            text-transform: uppercase;
            text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .advice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 4px dashed var(--op-card-border);
        }
        .advice-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--op-yellow-gold);
            padding: 20px 15px;
            border-radius: 10px;
            border: 3px solid var(--op-text-dark);
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.4);
        }
        .advice-icon { font-size: 2.8rem; margin-bottom: 10px; filter: drop-shadow(2px 2px 0 var(--op-text-dark)); }
        .advice-text { font-size: 1.5rem; font-weight: 900; color: var(--op-text-dark); margin: 5px 0; line-height: 1.2; text-transform: uppercase; text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.7); }
        .section-title { font-size: 1.6rem; color: var(--op-yellow-gold); margin-bottom: 20px; margin-left: 5px; font-weight: 900; text-shadow: 3px 3px 0 var(--op-text-dark); }
        .scroll-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 15px; scrollbar-width: none; -ms-overflow-style: none; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .mini-card { min-width: 150px; background: var(--op-card-bg); border-radius: 10px; padding: 22px 18px; text-align: center; border: 3px solid var(--op-card-border); flex-shrink: 0; box-shadow: 5px 5px 0 rgba(0, 0, 0, 0.3); }
        .mini-time { background: var(--op-bg-red-dark); color: var(--op-text-light); padding: 5px 14px; border-radius: 8px; font-size: 0.95rem; display: inline-block; margin-bottom: 12px; font-weight: bold; text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.2); }
        .mini-icon { font-size: 3.2rem; margin: 8px 0; }
        .mini-temp { font-size: 1.4rem; font-weight: 900; color: var(--op-text-dark); }
        
        .loading-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, var(--op-bg-red-light) 0%, var(--op-bg-red-dark) 30%, var(--op-sky-blue) 70%, #6A86B8 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999; color: white; text-shadow: 3px 3px 0 var(--op-text-dark); }
        .loading-screen .loader-icon { font-size: 6rem; animation: bounce-scale 2s ease-in-out infinite; filter: drop-shadow(0 0 15px var(--op-yellow-gold)); }
        @keyframes bounce-scale { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-20px) scale(1.1); } }
        .loading-screen p { font-size: 1.2rem; color: var(--op-yellow-gold); margin-top: 25px; font-weight: bold; }
        
        
        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 768px) {
            .hero-temp { font-size: 5.5rem; }
            .hero-icon { font-size: 6.5rem; }
            .hero-desc { font-size: 1.6rem; }
            .container { padding: 15px; }
            
            .city-nav {
                flex-direction: column;
                overflow-x: hidden;
                padding: 0;
                display: none; 
            }
            .city-nav.open {
                display: flex; 
            }
            .city-button {
                flex-shrink: 1;
                width: 100%;
                border-radius: 0;
                border-left: none;
                border-right: none;
                border-top: 1px solid rgba(255, 255, 255, 0.2);
                margin: 0;
                box-shadow: none;
                transform: none;
                text-align: left;
                padding: 15px 20px;
                background: rgba(255, 255, 255, 0.9); 
                box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
            }
            .city-button.selected {
                background: var(--op-bg-red-light);
                color: var(--op-text-light);
                border: 3px solid var(--op-yellow-gold);
            }
            .city-button:active {
                box-shadow: none;
                transform: none;
            }
            .menu-toggle {
                display: block; 
            }

            .status-bar {
                top: 55px; 
            }
        }

        @media (max-width: 320px) {
            .hero-temp { font-size: 4.5rem; }
            .hero-icon { font-size: 5.5rem; }
            .hero-desc { font-size: 1.4rem; }
            .advice-text { font-size: 1.1rem; }
            .advice-item { padding: 12px 8px; }
            .city-button { font-size: 0.9rem; }
            .hero-card { padding: 30px 20px; border-width: 4px; box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.7); }
            .mini-card { min-width: 120px; padding: 18px 10px; }
            .mini-time { font-size: 0.8rem; padding: 4px 10px; }
            .mini-icon { font-size: 2.5rem; }
            .mini-temp { font-size: 1.2rem; }
        }
    </style>
</head>

<body>
    <div id="loading" class="loading-screen">
        <div class="loader-icon">ğŸ–</div> 
        <p>æº–å‚™å¥½è¿æ¥æ–°ä¸–ç•Œçš„å¤©æ°£æŒ‘æˆ°äº†å—ï¼Ÿï¼</p>
    </div>

    <div class="city-nav-wrapper">
        <button class="menu-toggle" id="menuToggle">åŸå¸‚é¸å–® (ç›®å‰ï¼šè‡ºåŒ—å¸‚)</button>

        <div class="city-nav" id="cityNav">
        </div>
    </div>

    <div class="status-bar">
        <div id="locationIcon" class="location-icon-pill"></div>
        <div id="updateTime" class="update-pill">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <div id="heroCard">
            </div>

        <h3 class="section-title">ğŸ—ºï¸ èˆªæµ·å£«å¨œç¾çš„ç¾…ç›¤é æ¸¬</h3>
        <div class="scroll-container" id="futureForecasts">
            </div>
    </div>

    <script>
        const BASE_API_URL = "https://cwaweathertaichung.zeabur.app/api/weather/";
        const CITIES = [
            'è‡ºåŒ—å¸‚', 'æ–°åŒ—å¸‚', 'æ¡ƒåœ’å¸‚', 'æ–°ç«¹ç¸£', 'æ–°ç«¹å¸‚', 'è‹—æ —ç¸£', 
            'è‡ºä¸­å¸‚', 'å½°åŒ–ç¸£', 'é›²æ—ç¸£', 'å˜‰ç¾©å¸‚', 'é«˜é›„å¸‚', 'å®œè˜­ç¸£'
        ];
        
        let currentCity = 'è‡ºåŒ—å¸‚';
        let isGeoLocated = true; 

        // ----------------------------------------------------
        // *** ä¿®æ­£éŒ¯èª¤ï¼šè£œå›éºæ¼çš„è¼”åŠ©å‡½å¼å®šç¾© ***
        // ----------------------------------------------------
        function replaceTai(cityName) {
             return cityName.replace('è‡º', 'å°');
        }

        function getWeatherIcon(weather) {
            if (!weather) return "âš“";
            if (weather.includes("æ™´")) return "â˜€ï¸";
            if (weather.includes("å¤šé›²")) return "â˜ï¸";
            if (weather.includes("é™°")) return "ğŸŒ«ï¸";
            if (weather.includes("é›¨")) return "ğŸŒ§ï¸";
            if (weather.includes("é›·")) return "âš¡";
            if (weather.includes("é¢±é¢¨") || weather.includes("å¼·é¢¨")) return "ğŸŒªï¸";
            return "ğŸ´â€â˜ ï¸";
        }

        function getAdvice(rainProb, maxTemp) {
            let rainIcon = "ğŸ§­"; 
            let rainText = "é¢¨å¹³æµªéœ";
            if (parseInt(rainProb) > 30) {
                rainIcon = "ğŸŒŠ"; 
                rainText = "æº–å‚™æ‡‰å°é¢¨æµªï¼";
            } else if (parseInt(rainProb) > 60) {
                rainIcon = "â›ˆï¸";
                rainText = "æš´é¢¨é›¨ä¾†è¥²ï¼";
            }

            let clothIcon = "ğŸ‘•";
            let clothText = "è¼•ä¾¿å†’éšªæœ";
            if (parseInt(maxTemp) >= 28) {
                clothIcon = "ğŸ–ï¸";
                clothText = "æµ·å³¶æ¢éšªè£ï¼";
            } else if (parseInt(maxTemp) <= 20) {
                clothIcon = "ğŸ§¥";
                clothText = "åŠ ä»¶æŠ«é¢¨ï¼";
            } else if (parseInt(maxTemp) <= 15) {
                clothIcon = "ğŸ§£";
                clothText = "æ³¨æ„ä¿æš–ï¼";
            }

            return { rainIcon, rainText, clothIcon, clothText };
        }

        function getTimePeriod(startTime) {
            const hour = new Date(startTime).getHours();
            if (hour >= 5 && hour < 11) return "é»æ˜å‡ºèˆª";
            if (hour >= 11 && hour < 14) return "æ­£åˆæ¿€æˆ°";
            if (hour >= 14 && hour < 18) return "åˆå¾Œå°‹å¯¶";
            if (hour >= 18 && hour < 23) return "é»ƒæ˜åœæ³Š";
            return "å¤œé–“åµå¯Ÿ";
        }

        function formatDateTime(date) {
            const now = date;
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const hour = now.getHours();
            const dayIndex = now.getDay();
            const days = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
            return `${month}æœˆ${day}æ—¥${hour}æ™‚ ${days[dayIndex]}`;
        }
        // ----------------------------------------------------


        // 1. æ¸²æŸ“åŸå¸‚å°è¦½åˆ—
        function renderCityNav() {
            const nav = document.getElementById('cityNav');
            nav.innerHTML = CITIES.map(city => `
                <button class="city-button ${city === currentCity ? 'selected' : ''}" data-city="${city}">
                    ${replaceTai(city)} 
                </button>
            `).join('');

            // ç¶å®šé»æ“Šäº‹ä»¶
            nav.querySelectorAll('.city-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const newCity = e.currentTarget.getAttribute('data-city');
                    if (newCity !== currentCity) {
                        currentCity = newCity;
                        isGeoLocated = false; // è¨­ç‚ºæ‰‹å‹•é¸å–
                        
                        // è™•ç†æ‰‹æ©Ÿç‰ˆé¸å–®æ”¶åˆ
                        nav.classList.remove('open');
                        
                        // ç«‹å³æ›´æ–°ç‹€æ…‹æ¬„ä¸¦ç²å–å¤©æ°£
                        updateLocationIcon(); 
                        fetchWeather(true);
                    }
                });
            });
            
            // ç¢ºä¿é¸ä¸­çš„åŸå¸‚æŒ‰éˆ•åœ¨å¯è¦‹ç¯„åœå…§ (æ¡Œé¢ç‰ˆ)
            const selectedButton = nav.querySelector('.city-button.selected');
            if (selectedButton && window.innerWidth > 768) {
                selectedButton.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            }
            
            // æ›´æ–°æ‰‹æ©Ÿç‰ˆé¸å–®æŒ‰éˆ•æ–‡å­—
            document.getElementById('menuToggle').textContent = `åŸå¸‚é¸å–® (ç›®å‰ï¼š${replaceTai(currentCity)})`;
        }
        
        // 2. æ›´æ–°å³ä¸Šè§’å®šä½åœ–ç¤º (è² è²¬è™•ç†å®šä½èˆ‡æ‰‹å‹•é¸å–çš„ç‹€æ…‹é¡¯ç¤º)
        function updateLocationIcon() {
            const locationIconElement = document.getElementById('locationIcon');
            locationIconElement.style.display = 'block'; 
            locationIconElement.classList.remove('manual-select');
            
            if (isGeoLocated) {
                // åœ°ç†å®šä½ç‹€æ…‹ï¼šé¡¯ç¤ºå®šä½åœ–é‡˜
                locationIconElement.innerHTML = `ğŸ“ ${replaceTai(currentCity)}`;
            } else {
                // æ‰‹å‹•é¸å–ç‹€æ…‹ï¼šé¡¯ç¤ºç¾…ç›¤
                locationIconElement.innerHTML = `ğŸ—ºï¸ ${replaceTai(currentCity)}`;
                locationIconElement.classList.add('manual-select');
            }
        }


        // 3. æ¸²æŸ“å¤©æ°£è³‡æ–™
        function renderWeather(data) {
            const forecasts = data.forecasts;
            if (!forecasts || forecasts.length === 0) {
                throw new Error("API å›å‚³è³‡æ–™æ ¼å¼éŒ¯èª¤æˆ–ç„¡é å ±è³‡æ–™");
            }

            const current = forecasts[0];
            const others = forecasts.slice(1);
            
            const advice = getAdvice(current.rain, current.maxTemp);
            const avgTemp = Math.round((parseInt(current.maxTemp) + parseInt(current.minTemp)) / 2);

            document.getElementById('heroCard').innerHTML = `
                <div class="hero-card">
                    <div class="hero-period">æ‡¸è³ä»¤ï¼š${replaceTai(currentCity)}å¤©æ°£</div>
                    <div class="hero-temp-container">
                        <div class="hero-icon">${getWeatherIcon(current.weather)}</div>
                        <div class="hero-temp">${avgTemp}Â°</div>
                    </div>
                    <div class="hero-desc">${current.weather}</div>
                    
                    <div class="advice-grid">
                        <div class="advice-item">
                            <div class="advice-icon">${advice.rainIcon}</div>
                            <div class="advice-text">${advice.rainText}</div>
                            <div style="font-size:0.75rem; color:var(--op-text-dark); font-weight:700;">é™é›¨ç‡ ${current.rain}%</div>
                        </div>
                        <div class="advice-item">
                            <div class="advice-icon">${advice.clothIcon}</div>
                            <div class="advice-text">${advice.clothText}</div>
                            <div style="font-size:0.75rem; color:var(--op-text-dark); font-weight:700;">é«˜æº« ${current.maxTemp}Â° / ä½æº« ${current.minTemp}Â°</div>
                        </div>
                    </div>
                </div>
            `;

            const scrollContainer = document.getElementById('futureForecasts');
            scrollContainer.innerHTML = '';
            const todayDate = new Date().getDate();

            others.forEach(f => {
                let p = getTimePeriod(f.startTime);
                const fDate = new Date(f.startTime);
                if (fDate.getDate() !== todayDate) {
                    p = "æ˜æ—¥" + p.replace('é»æ˜å‡ºèˆª', 'é»æ˜').replace('æ­£åˆæ¿€æˆ°', 'æ­£åˆ').replace('åˆå¾Œå°‹å¯¶', 'åˆå¾Œ').replace('é»ƒæ˜åœæ³Š', 'é»ƒæ˜').replace('å¤œé–“åµå¯Ÿ', 'å¤œé–“');
                }

                scrollContainer.innerHTML += `
                    <div class="mini-card">
                        <div class="mini-time">${p}</div>
                        <div class="mini-icon">${getWeatherIcon(f.weather)}</div>
                        <div class="mini-temp">${f.minTemp}Â° - ${f.maxTemp}Â°</div>
                        <div style="font-size:0.8rem; color:var(--op-text-dark); margin-top:5px; font-weight: bold;">ğŸ’§${f.rain}%</div>
                    </div>
                `;
            });

            document.getElementById('updateTime').textContent = formatDateTime(new Date());

            // é‡æ–°æ¸²æŸ“å°è¦½åˆ—ä»¥æ›´æ–°é¸ä¸­ç‹€æ…‹
            renderCityNav();
            // æ›´æ–°å®šä½ç‹€æ…‹ (ç„¡è«–å®šä½æˆ–æ‰‹å‹•é¸å–ï¼Œéƒ½æœƒé¡¯ç¤ºç›®å‰åŸå¸‚)
            updateLocationIcon(); 
        }

        // 4. ç²å–å¤©æ°£è³‡æ–™ (ç•¥)
        async function fetchWeather(isManual = false) {
            const API_URL = BASE_API_URL + currentCity;
            
            if (!isManual) {
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';
            }

            try {
                const delayPromise = new Promise(resolve => setTimeout(resolve, isManual ? 200 : 1500));
                const fetchPromise = fetch(API_URL).then(res => {
                    if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                    return res.json();
                });

                const [_, json] = await Promise.all([delayPromise, fetchPromise]);

                if (json.success) {
                    renderWeather(json.data);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } else {
                    throw new Error(json.message || "API éŒ¯èª¤");
                }
            } catch (e) {
                console.error("Fetch Weather Error:", e);
                document.getElementById('loading').innerHTML = `
                    <div class="loader-icon">â˜ ï¸</div>
                    <p>èˆªæµ·æ—¥èªŒéºå¤±ï¼ç„¡æ³•è®€å–æ–°ä¸–ç•Œçš„å¤©æ°£é å ±ï¼</p>
                    <p style="color: white; font-size: 0.9rem; margin-top: 10px;">
                        éŒ¯èª¤è¨Šæ¯: ${e.message || "ç¶²è·¯é€£ç·šæˆ–ä¼ºæœå™¨å•é¡Œ"}
                    </p>
                `;
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';
            }
        }
        
        // 5. åœ°ç†å®šä½åŠŸèƒ½
        function getGeolocationCity() {
            const locationIconElement = document.getElementById('locationIcon');

            if (navigator.geolocation) {
                locationIconElement.style.display = 'block'; 
                locationIconElement.innerHTML = 'ğŸ§­ å®šä½ä¸­...'; 
                
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    isGeoLocated = true; 
                    
                    try {
                        let detectedCity = 'è‡ºåŒ—å¸‚'; 
                        
                        // æ¨¡æ“¬ GeoCoding æ ¹æ“šåº§æ¨™åˆ¤æ–·åŸå¸‚
                        if (lat > 24.1 && lat < 24.3 && lon > 120.6 && lon < 120.7) { 
                            detectedCity = 'è‡ºä¸­å¸‚';
                        } else if (lat > 22.5 && lat < 23.0 && lon > 120.1 && lon < 120.4) {
                            detectedCity = 'é«˜é›„å¸‚';
                        } else if (lat > 24.7 && lat < 24.8 && lon > 120.9 && lon < 121.1) {
                            detectedCity = 'æ–°ç«¹å¸‚'; 
                        }
                        
                        currentCity = detectedCity;
                        updateLocationIcon(); 
                        fetchWeather(); 
                    } catch (e) {
                        console.error("GeoCoding Error:", e);
                        // GeoCoding å¤±æ•—ä½†å®šä½æˆåŠŸï¼Œä»ä½¿ç”¨é è¨­åŸå¸‚ï¼Œä¸¦å°‡ç‹€æ…‹æ¨™è¨˜ç‚ºå®šä½å¤±æ•—
                        isGeoLocated = false;
                        locationIconElement.innerHTML = 'âš ï¸ å®šä½å¤±æ•— (ä½¿ç”¨é è¨­)'; 
                        fetchWeather();
                    }

                }, (error) => {
                    console.warn('Geolocation failed:', error);
                    // æ•´å€‹å®šä½æµç¨‹å¤±æ•—
                    isGeoLocated = false;
                    locationIconElement.innerHTML = 'âš ï¸ å®šä½å¤±æ•— (ä½¿ç”¨é è¨­)'; 
                    fetchWeather(); 
                }, { timeout: 5000 });
            } else {
                console.log("Geolocation is not supported by this browser.");
                isGeoLocated = false;
                locationIconElement.style.display = 'block';
                locationIconElement.innerHTML = 'ğŸš© ç„¡æ³•å®šä½ (ä½¿ç”¨é è¨­)'; 
                fetchWeather(); 
            }
        } 

        // 6. åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š
        document.addEventListener("DOMContentLoaded", () => {
            const menuToggle = document.getElementById('menuToggle');
            const cityNav = document.getElementById('cityNav');
            
            // ç¶å®šæ‰‹æ©Ÿç‰ˆé¸å–®é–‹é—œ
            menuToggle.addEventListener('click', () => {
                cityNav.classList.toggle('open');
            });
            
            getGeolocationCity(); 
        });

    </script>
</body>

</html>